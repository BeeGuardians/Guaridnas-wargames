name: Deploy CTF Problems

on:
  push:
    paths:
      - '*/*'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      folders: ${{ steps.set.outputs.folders }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Detect changed top-level folders
        id: set
        run: |
          echo "ðŸ” Detecting changed top-level folders..."

          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          CUR_COMMIT=$(git rev-parse HEAD)

          if [ -z "$PREV_COMMIT" ]; then
            echo "âš ï¸ No previous commit found. Using current commit only."
            CHANGED=$(git show --name-only --pretty="" "$CUR_COMMIT" | awk -F/ '{print $1}' | sort -u)
          else
            CHANGED=$(git diff --name-only "$PREV_COMMIT" "$CUR_COMMIT" | awk -F/ '{print $1}' | sort -u)
          fi

          echo "ðŸ“¦ Changed folders raw:"
          echo "$CHANGED"

          if [ -z "$CHANGED" ]; then
            echo 'folders=[]' >> $GITHUB_OUTPUT
          else
            FOLDERS_JSON=$(echo "$CHANGED" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "folders=$FOLDERS_JSON" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.detect-changes.outputs.folders) != '[]' }}
    strategy:
      matrix:
        folder: ${{ fromJson(needs.detect-changes.outputs.folders) }}

    steps:
      - name: Checkout
